<style>
    .recommend-container > span {
       font-weight: 600;
       margin-bottom: 12px;
       display: block;
       font-size: 12px;
    }

   .recommend-container select {
      padding: 0px 15px 0px 5px;
      min-height: 30px;
      max-width: calc(100% - 20px);
      width: 100%;
      border-radius: 0;
      border: 1px solid #c7c7c7;
      background-color: #fff;
      color: #212322;
   }

   body.iOS .recommend-container select {
      max-width: calc(100% - 15px);
   }
   .recommend-container {
      z-index: 0;
      position: relative;
      background: #fff;
      padding: 5px 30px 10px;
      opacity: 0;
      pointer-events: none;
      transition: all .3s ease;
   }

   .recommend-container.loaded {
         opacity: 1;
         pointer-events: all;
   }

  img.recommend-item-image {
      height: 130px;
      object-fit: cover;
      width: 100%;
   }
   .infoProduct  {
      flex: 1;
   }
   .infoProduct h4 {
      margin-top: 0px;
      margin-bottom: 0px;
   }
   .cart-recommend .slick-track {
      display: flex;
   }
   .cart-recommend .recommend-slider + *  {
      display: none !important;
   }
   .infoProduct .size {
      color: #fff;
      font-size: 12px;
      opacity: .8;
   }
   .infoProduct h4 a {
      font-weight: 600;
      font-size: 12px;
      letter-spacing: 0;
      margin-top: 0px;
      margin-bottom: 0;
      line-height: 1.2;
      -webkit-line-clamp: 1;
      max-width: 100%;
      overflow: hidden;
      white-space: normal;
      display: -webkit-box;
      text-overflow: ellipsis;
      -webkit-box-orient: vertical;
      margin-top: 5px;
      font-family: var(--font-body-family);
      font-style: normal;
   }
   .infoProduct .color-selected {
      font-size: 9px;
      color: #858585;
      text-transform: uppercase;
   }
   .infoProduct select {
      font-size: 12px;
      margin-bottom: 5px;
      appearance: auto;
   }
   .infoProduct span.price {
      justify-content: flex-start;
      font-size: 12px;
   }
   .recommend-btn-add {
      font-size: 12px;
      width: 100%;
      border-radius: 6px !important;
      min-width: auto !important;
      border: none;
      background: linear-gradient(90deg, rgba(255, 199, 232, 1), rgba(231, 201, 156, 1) 100%); !important;
      color: #232323 !important;
      height: 32px;
      padding: 0;
   }
   .recommend-btn-add[disabled] {
     background: #c7c7c7
   }
   .infoProduct .color-selected {
      font-size: 10px;
      color: #858585;
      text-transform: initial;
      display: block;
      line-height: 1;
      margin-bottom: 3px;
      margin-top: 5px;
   }
   /* .recommend-slider {
      padding-bottom: 30px;
   } */
   .recommend-slider >.swiper-scrollbar {
      opacity: 1 !important;
      bottom: 0;
   }
   .recommend-container h3 {
      font-size: 16px;
      margin-bottom: 12px;
   }
   .frete-container h4 {
      margin-bottom: 5px;
   }
   .variants-product-selects select option:first-child {
      color: #888;
   }
   /* Estilizando a opção selecionada */
   .variants-product-selects select option:checked {
      color: #333;
   }
   .item-recommend a.image:first-child {
      position: relative;
      padding-top: var(--aspect);
      display: block;
      border-radius: 0;
      overflow: hidden;
      /* padding-bottom: 100%; */
      align-items: center;
   }
   .cart-recommend .swiper-button-disabled {
      display: none;
   }

   .recommend-slider:not(.swiper-initialized) .swiper-button-prev,
   .recommend-slider:not(.swiper-initialized) .swiper-button-next{
      display: none;
   }
   .item-recommend a.image img {
      top: 0;
      object-fit: cover;
      width: 70px !important;
      height: 70px !important;
   }
   .carrinho-middle {
      margin-bottom: 15px;
   }
   .carrinho-middle {
      scrollbar-width: auto;
      scrollbar-color: #727272 #e5e5e5;
   }
   .carrinho-middle::-webkit-scrollbar {
      width: 5px;
   }
   .carrinho-middle::-webkit-scrollbar-track {
      background: #e5e5e5;
   }
   .carrinho-middle::-webkit-scrollbar-thumb {
      background-color: #727272;
      border-radius: 10px;
      border: 0px none #ffffff;
   }
   .carrinho-middle {
      padding: 0 20px 20px 20px;
      margin-right: 5px;
   }
   .carrinho-bottom {
      padding: 0 20px 10px 20px;
      box-shadow: 0px -2px 16px 1px #00000029;
   }
   .carrinho-top {
      padding: 0 20px;
      box-shadow: 0px 2px 16px 1px #00000029;
      margin-bottom: 5px;
   }

   .item-recommend {
      background: var(--item-background);
      padding: 8px;
      border-radius: 6px;
      margin-right: 6px;
      min-width: 80%;
      display: flex;
      gap: 6px;
   }

   .infoProduct h4 a,
   .infoProduct .price {
     color: #fff;
   }

   .recommend-btn-add {
     background: #fff !important;
   }
   #dropdown-cart.updating-cart .mini-products-list .product-image, #dropdown-cart.updating-cart .recommend-container .image{
      position: relative;
   }
   #dropdown-cart.updating-cart .mini-products-list .product-image img, #dropdown-cart.updating-cart .recommend-container .image img{
      opacity: 0;
   }
   #dropdown-cart.updating-cart .mini-products-list .product-image:before, #dropdown-cart.updating-cart .recommend-container .image:before{
      content: "";
      max-height: 120px;
      width: 110px;
      height: 100%;
      background: #eee;
      background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
      border-radius: 5px;
      background-size: 200% 100%;
      -webkit-animation: 1.5s shine linear infinite;
      animation: 1.5s shine linear infinite;
      position: absolute;
      top: 0;
   }
   #dropdown-cart.updating-cart .product-details .product-name, #dropdown-cart.updating-cart .product-details .option, #dropdown-cart.updating-cart .mini-products-list .item .cart-collateral .price, #dropdown-cart.updating-cart .quantity .item-quantity{
      background: #eee;
      background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
      background-size: 200% 100%;
      -webkit-animation: 1.5s shine linear infinite;
      animation: 1.5s shine linear infinite;
      line-height: 18px;
   }
   #dropdown-cart.updating-cart .quantity .item-quantity {
      font-size: 0;
      border: none;
   }
   #dropdown-cart.updating-cart .mini-products-list .item .cart-collateral .price {
      width: 65px;
      line-height: 15px;
   }
   #dropdown-cart.updating-cart .product-details .option{
      max-width: 100px;
   }
   #dropdown-cart.updating-cart .product-details .option * {
      font-size: 0px !important;
      animation: all 0s;
      line-height: 4px !important;
      opacity: 0;
   }
   #dropdown-cart.updating-cart .product-details .product-name, #dropdown-cart.updating-cart .product-details .poption *, #dropdown-cart.updating-cart .mini-products-list .item .cart-collateral .price{
      font-size: 0px !important;
      animation: all 0s;
   }
   @keyframes shine {
      to {
          background-position-x: -200%;
     }
   }
   .progress-meter {
      animation: none !important;
      background-image: none !important;
      height: 7px !important;
      font-size: 0px;
   }
   .progress_shipping {
      height: 7px !important;
   }

   .swiper-wrapper:not(.slick-initialized) {
       display: flex;
   }

   .swiper-wrapper .slick-dots {
       position: relative;
       bottom: 0;
       margin-top: 12px;
   }

   .swiper-wrapper {
      overflow: auto;
   }
</style>

<div class="recommend-container">
  <span class="text">Outros produtos que você pode gostar</span>
  <div class="cart-recommend scrollbar-x" id="style-1">
    <div class="swiper recommend-slider">
      <div class="swiper-wrapper"></div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    window.cartitems = {{cart.items | json}};
    window.addedUpsellItems = []; // Array para armazenar os IDs dos produtos já adicionados

    window.updateUpsell = function() {
        var cartItems = window.cartitems;

        cartItems.forEach(function(item) {
            var sectionId = '';

            function getProductRecommendations(item) {
                if (!sectionId) {
                    var recommendationsUrlFirst = `{{shop.url}}/search?view=upsell`;

                    $.ajax({
                        url: recommendationsUrlFirst,
                        beforeSend: function () {
                            console.log("Buscando ID da seção de recomendações para o produto:", item.handle);
                        },
                        success: function (data) {
                            var htmlData = $.parseHTML(data);
                            var sectionElement = $(htmlData[0]);

                            if (sectionElement.length > 0) {
                               console.log("sectionElement:", sectionElement);
                                sectionId = sectionElement.attr('id').replace('shopify-section-', '');
                                console.log("sectionId após tratamento:", sectionId);

                                // Chama a função para buscar as recomendações
                                fetchRecommendations(item);
                            } else {
                                console.log("Nenhum elemento com a classe '.halo-product-block-sections' foi encontrado.");
                            }
                        },
                        error: function (xhr, text) {
                            console.log("Erro ao buscar ID da seção de recomendações para o produto:", item.handle);
                        }
                    });
                } else {
                    fetchRecommendations(item);
                }
            }

            function fetchRecommendations(item) {
                var recommendationsUrl = `{{shop.url}}/recommendations/products?view=recomendations&section_id=${sectionId}&product_id=${item.product_id}&limit=6`;

                $.ajax({
                    url: recommendationsUrl,
                    success: function (data) {
                        var newUpsellItems = $(data).find('.item-recommend');

                        newUpsellItems.each(function () {
                            var prodId = JSON.parse($(this).find('[data-json-product]').text())[0].id;
                            if (window.addedUpsellItems.indexOf(prodId) === -1 && window.addedUpsellItems.length < 8) {
                                $('.recommend-slider .swiper-wrapper').append(this);
                                window.addedUpsellItems.push(prodId);
                            }
                        });
                    },
                    error: function (xhr, text) {
                        console.log("Erro ao buscar recomendações para produto ID:", item.product_id);
                    },
                    complete: function () {
                        console.log("Busca por recomendações completa para produto ID:", item.product_id);
                        if (cartItems.indexOf(item) === cartItems.length - 1) {
                            window.upsellSliderInit();
                        }
                    }
                });
            }

            getProductRecommendations(item);
        });
    };

    window.updateUpsell();
  });
</script>
